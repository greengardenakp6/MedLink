<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedLink AI - Robust & Interactive</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Typing Cursor */
        .typing-cursor::after { content: '|'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Bed Pulse Animation */
        .ai-bed-highlight { animation: highlightPulse 2s infinite; border-color: #4f46e5; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }
        @keyframes highlightPulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen w-screen overflow-hidden">

    <!-- ================= AUTH SCREEN ================= -->
    <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
        <div class="bg-white/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-md animate-fade-in border border-white/50">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4 animate-pulse-fast">üè•</div>
                <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">MedLink AI</h1>
                <p class="text-slate-500 mt-2 text-sm">Next-Gen Healthcare Workflow</p>
            </div>

            <!-- Interactive Switch -->
            <div class="flex bg-slate-200/50 p-1 rounded-xl mb-8 relative">
                <div id="switch-bg" class="absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-white shadow-sm rounded-lg transition-all duration-300"></div>
                <button id="tab-login" onclick="setAuthMode('login')" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all duration-300 relative z-10 text-indigo-600">Login</button>
                <button id="tab-signup" onclick="setAuthMode('signup')" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all duration-300 relative z-10 text-slate-500">Sign Up</button>
            </div>

            <form onsubmit="handleAuth(event)" class="space-y-5">
                <!-- Role Selector (Visible only in Signup) -->
                <div id="role-select" class="hidden grid grid-cols-2 gap-4 mb-4">
                    <button type="button" onclick="selectRole('patient', this)" class="role-card group relative overflow-hidden border-2 border-slate-200 rounded-2xl p-4 flex items-center gap-4 transition-all duration-300 hover:shadow-lg bg-white">
                        <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">üë§</div>
                        <div class="text-left">
                            <div class="font-bold text-slate-700 text-sm">Patient</div>
                            <div class="text-xs text-slate-400">Book Appointment</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectRole('admin', this)" class="role-card group relative overflow-hidden border-2 border-slate-200 rounded-2xl p-4 flex items-center gap-4 transition-all duration-300 hover:shadow-lg bg-white">
                        <div class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">‚öñÔ∏è</div>
                        <div class="text-left">
                            <div class="font-bold text-slate-700 text-sm">Admin</div>
                            <div class="text-xs text-slate-400">Approve Requests</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectRole('doctor', this)" class="role-card group relative overflow-hidden border-2 border-slate-200 rounded-2xl p-4 flex items-center gap-4 transition-all duration-300 hover:shadow-lg bg-white">
                        <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">ü©∫</div>
                        <div class="text-left">
                            <div class="font-bold text-slate-700 text-sm">Doctor</div>
                            <div class="text-xs text-slate-400">AI Diagnose</div>
                        </div>
                    </button>
                    <button type="button" onclick="selectRole('nurse', this)" class="role-card group relative overflow-hidden border-2 border-slate-200 rounded-2xl p-4 flex items-center gap-4 transition-all duration-300 hover:shadow-lg bg-white">
                        <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">üè•</div>
                        <div class="text-left">
                            <div class="font-bold text-slate-700 text-sm">Nurse</div>
                            <div class="text-xs text-slate-400">Manage Beds</div>
                        </div>
                    </button>
                </div>

                <div class="space-y-2">
                    <input type="text" id="username" placeholder="Username" required class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all duration-300 bg-white/50">
                    <input type="password" id="password" placeholder="Password" required class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all duration-300 bg-white/50">
                </div>
                
                <button type="submit" id="auth-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center gap-2">
                    <span id="auth-btn-text">Login</span>
                </button>
            </form>
            
            <!-- Debug/Storage Status -->
            <div id="storage-status" class="mt-4 text-xs text-center text-slate-400 hidden">
                Storage Mode: <span class="font-bold text-indigo-600">Local Persistence</span>
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP ================= -->
    <div id="app-container" class="hidden flex h-full w-full">
        
        <!-- SIDEBAR -->
        <aside class="w-72 bg-white border-r border-slate-100 flex flex-col shadow-xl z-10">
            <div class="p-8 flex items-center gap-4 border-b border-slate-50">
                <div class="text-3xl">ü©∫</div>
                <div class="font-bold text-2xl text-slate-800 tracking-tight">MedLink AI</div>
            </div>
            
            <nav id="nav-menu" class="flex-1 p-6 space-y-3">
                <!-- Nav items injected by JS -->
            </nav>

            <div class="p-6 border-t border-slate-100">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-inner">
                    <div id="user-name" class="font-bold text-slate-800 text-lg">User</div>
                    <div id="user-role" class="text-xs text-indigo-500 font-semibold uppercase tracking-widest mt-0.5">Role</div>
                </div>
                <button onclick="logout()" class="w-full mt-6 py-3 text-sm text-red-500 font-bold bg-red-50 hover:bg-red-100 rounded-xl transition-colors">
                    Logout
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 bg-slate-50/80 h-full overflow-y-auto hide-scrollbar relative">
            <div id="main-content" class="p-8 max-w-8xl mx-auto min-h-full">
                <!-- Dynamic Content -->
            </div>
        </main>
    </div>

    <!-- ================= CHATBOT WIDGET ================= -->
    <div class="fixed bottom-8 right-8 z-40">
        <!-- Chat Window -->
        <div id="chat-window" class="hidden absolute bottom-24 right-0 w-80 h-[500px] bg-white rounded-3xl shadow-2xl border border-slate-100 overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0 origin-bottom-right">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white rounded-t-3xl">
                <div class="font-bold flex items-center gap-2">ü§ñ MedBot <span class="text-xs bg-white/20 px-2 py-0.5 rounded-full">AI</span></div>
                <button onclick="toggleChat()" class="hover:bg-indigo-700 p-1 rounded-lg transition-colors">&times;</button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50 space-y-3">
                <!-- Messages -->
            </div>
            <div class="p-4 border-t border-slate-100 bg-white flex gap-3">
                <input type="text" id="chat-input" placeholder="Ask MedBot..." onkeypress="if(event.key==='Enter')sendChat()" class="flex-1 bg-slate-50 border-none rounded-full px-5 py-2.5 text-sm focus:ring-2 focus:ring-indigo-100 outline-none transition-all shadow-inner">
                <button onclick="sendChat()" class="bg-indigo-600 hover:bg-indigo-700 text-white w-11 h-11 rounded-full flex items-center justify-center transition-transform active:scale-95 shadow-md hover:shadow-xl">‚û§</button>
            </div>
        </div>

        <!-- Toggle Button -->
        <button onclick="toggleChat()" class="w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl hover:shadow-3xl hover:scale-105 active:scale-95 transition-all duration-300 flex items-center justify-center text-3xl animate-pulse-fast border-4 border-indigo-200 ring-2 ring-indigo-200">
            üí¨
        </button>
    </div>

    <!-- ================= TOAST NOTIFICATION ================= -->
    <div id="toast-area" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <script>
        // --- 1. DATA & STORAGE ---
        const DB_KEY = 'medlink_robust_v4_db';
        
        const defaultDB = {
            users: [
                { u: 'admin', p: '123', r: 'admin', n: 'Admin User' },
                { u: 'doc', p: '123', r: 'doctor', n: 'Dr. Strange' },
                { u: 'nurse', p: '123', r: 'nurse', n: 'Joy Nurse' },
                { u: 'pat', p: '123', r: 'patient', n: 'John Doe' }
            ],
            doctors: [
                { n: "Dr. Sarah", spec: "Cardiology" },
                { n: "Dr. Alan", spec: "Orthopedics" },
                { n: "Dr. Ellie", spec: "General" }
            ],
            // Bed Data: includes type, status, and patient details if occupied
            beds: Array.from({length:20}, (_,i)=>({
                id: i+1, 
                label: `E${i+1}`, 
                status: i<5 ? 'occupied' : 'free',
                patientId: i<5 ? `P-${100+i}` : null
            })),
            appointments: []
        };

        let DB = { ...defaultDB }; // Global State

        // ROBUST SAVE FUNCTION (Try/Catch block)
        let isStorageAvailable = true;
        function saveDB() {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(DB));
                const statusEl = document.getElementById('storage-status');
                if(statusEl) statusEl.classList.remove('hidden');
            } catch (e) {
                isStorageAvailable = false;
                console.error("Storage Error (likely local file restriction):", e);
                const statusEl = document.getElementById('storage-status');
                if(statusEl) {
                    statusEl.classList.remove('hidden');
                    statusEl.innerHTML = `<span class="text-red-500 font-bold">Storage Blocked</span> (Running in Memory Mode)`;
                    statusEl.classList.add('flex', 'items-center', 'justify-center');
                }
                // Do not crash, just continue with memory
            }
        }

        function loadDB() {
            if (typeof(Storage) !== "undefined") {
                try {
                    const stored = localStorage.getItem(DB_KEY);
                    if (stored) {
                        DB = { ...defaultDB, ...JSON.parse(stored) };
                    }
                } catch(e) {
                    console.log("Storage not accessible, using defaults");
                }
            }
        }

        // Load data immediately
        loadDB();

        let currentUser = null;
        let authMode = 'login';
        let selectedRole = 'patient';

        // --- 2. AUTH LOGIC ---
        function setAuthMode(mode) {
            authMode = mode;
            const bg = document.getElementById('switch-bg');
            const loginTab = document.getElementById('tab-login');
            const signupTab = document.getElementById('tab-signup');
            const roleDiv = document.getElementById('role-select');
            const authBtn = document.getElementById('auth-btn');
            const btnText = document.getElementById('auth-btn-text');

            if (mode === 'login') {
                bg.style.left = '4px';
                loginTab.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                loginTab.classList.remove('text-slate-500');
                signupTab.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                signupTab.classList.add('text-slate-500');
                roleDiv.classList.add('hidden');
                btnText.innerText = 'Login';
            } else {
                bg.style.left = 'calc(50% + 4px)';
                signupTab.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                signupTab.classList.remove('text-slate-500');
                loginTab.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                loginTab.classList.add('text-slate-500');
                roleDiv.classList.remove('hidden');
                roleDiv.classList.add('animate-fade-in');
                btnText.innerText = 'Create Account';
            }
        }

        function selectRole(role, btn) {
            selectedRole = role;
            // Remove active state from all
            document.querySelectorAll('.role-card').forEach(b => {
                b.classList.remove('border-indigo-500', 'ring-2', 'ring-indigo-200', 'bg-indigo-50');
                b.classList.add('border-slate-200');
            });
            // Add active state to clicked
            btn.classList.remove('border-slate-200');
            btn.classList.add('border-indigo-500', 'ring-2', 'ring-indigo-200', 'bg-indigo-50');
        }

        function handleAuth(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const btn = document.getElementById('auth-btn');
            
            if (!u || !p) {
                showToast('Please fill all fields', 'error');
                return;
            }

            if (authMode === 'login') {
                const user = DB.users.find(x => x.u === u && x.p === p);
                if (user) { 
                    currentUser = user; 
                    enterApp(); 
                } else { 
                    showToast('Invalid Credentials', 'error'); 
                }
            } else {
                // SIGN UP LOGIC
                if (DB.users.find(x => x.u === u)) {
                    showToast('Username already exists', 'error');
                    return;
                }
                
                // Visual feedback for signup
                btn.innerHTML = `<span class="animate-spin inline-block mr-2">‚åõ</span> Creating Account...`;
                btn.disabled = true;

                setTimeout(() => {
                    const newUser = { u, p, r: selectedRole, n: u };
                    
                    // Add to DB
                    DB.users.push(newUser);
                    
                    // Attempt Save
                    saveDB();
                    
                    // Set User
                    currentUser = newUser;
                    
                    showToast(`Account Created: ${selectedRole.toUpperCase()}`, 'success');
                    enterApp();
                }, 800);
            }
        }

        function enterApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            document.getElementById('user-name').innerText = currentUser.n;
            document.getElementById('user-role').innerText = currentUser.r.toUpperCase();

            initMenu();
            
            // Route based on role
            if (currentUser.r === 'patient') navigate('patient-dashboard');
            else navigate(currentUser.r + '-dashboard');
        }

        function logout() { location.reload(); }

        // --- 3. NAVIGATION ---
        function initMenu() {
            const menu = document.getElementById('nav-menu');
            menu.innerHTML = '';
            const routes = [
                { id: 'patient-dashboard', label: 'My Health', icon: 'üëã', roles: ['patient'] },
                { id: 'admin-dashboard', label: 'Requests', icon: 'üìã', roles: ['admin'] },
                { id: 'doctor-dashboard', label: 'Diagnose AI', icon: 'ü©∫', roles: ['doctor'] },
                { id: 'nurse-dashboard', label: 'Smart Beds', icon: 'üõèÔ∏è', roles: ['nurse'] }
            ];

            routes.forEach(r => {
                if (r.roles.includes(currentUser.r)) {
                    const item = document.createElement('a');
                    item.href = "#";
                    item.id = 'nav-' + r.id;
                    item.className = 'flex items-center gap-3 px-5 py-3 text-sm font-medium text-slate-600 rounded-xl transition-all duration-300 hover:bg-indigo-50 hover:text-indigo-600 group';
                    item.innerHTML = `<span class="text-2xl group-hover:scale-110 transition-transform">${r.icon}</span> <span class="font-semibold">${r.label}</span>`;
                    item.onclick = (e) => { e.preventDefault(); navigate(r.id); };
                    menu.appendChild(item);
                }
            });
        }

        function navigate(viewId) {
            document.querySelectorAll('#nav-menu a').forEach(a => a.classList.remove('bg-indigo-50', 'text-indigo-600'));
            const activeLink = document.getElementById('nav-' + viewId);
            if(activeLink) activeLink.classList.add('bg-indigo-50', 'text-indigo-600');

            const content = document.getElementById('main-content');
            content.classList.remove('animate-fade-in'); 
            void content.offsetWidth; 
            content.classList.add('animate-fade-in');

            if (viewId === 'patient-dashboard') renderPatient(content);
            else if (viewId === 'admin-dashboard') renderAdmin(content);
            else if (viewId === 'doctor-dashboard') renderDoctor(content);
            else if (viewId === 'nurse-dashboard') renderNurse(content);
        }

        // --- 4. VIEW: PATIENT ---
        function renderPatient(c) {
            c.innerHTML = `
                <div class="mb-10">
                    <h2 class="text-4xl font-extrabold text-slate-800 tracking-tight">Welcome Back, <span class="text-indigo-600">${currentUser.n}</span></h2>
                    <p class="text-slate-500">Book an appointment and get instant AI triage support.</p>
                </div>

                <div class="grid lg:grid-cols-2 gap-10">
                    <!-- Booking Form -->
                    <div class="bg-white rounded-3xl p-8 shadow-xl border border-slate-100 hover:shadow-2xl transition-all duration-500">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-1.5 rounded-full text-xs font-bold tracking-wide shadow-lg">AI POWERED</div>
                            <h3 class="font-bold text-xl text-slate-800">Book Appointment</h3>
                        </div>
                        
                        <form onsubmit="bookAppt(event)" class="space-y-5">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Full Name</label>
                                <input type="text" id="p-name" value="${currentUser.n}" readonly class="w-full px-5 py-3.5 rounded-2xl bg-slate-50 border-none text-slate-400 font-medium text-sm shadow-inner">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Age</label>
                                    <input type="number" id="p-age" required class="w-full px-5 py-3.5 rounded-2xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all duration-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Phone</label>
                                    <input type="text" id="p-phone" required class="w-full px-5 py-3.5 rounded-2xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all duration-300">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Primary Issue</label>
                                <select id="p-issue" onchange="analyzeSymptom(this.value)" class="w-full px-5 py-3.5 rounded-2xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all duration-300 bg-white cursor-pointer">
                                    <option value="">Select Symptoms...</option>
                                    <option value="Fever">High Fever (>38¬∞C)</option>
                                    <option value="Chest">Chest Pain</option>
                                    <option value="Fracture">Bone Fracture</option>
                                </select>
                            </div>
                            
                            <div id="ai-hint" class="hidden bg-indigo-50/80 border-l-4 border-indigo-500 rounded-r-2xl p-5 text-sm text-slate-700 mt-4 animate-fade-in relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-2 opacity-20">
                                    <svg class="w-6 h-6 text-indigo-500 animate-pulse-fast" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100-16 8 8 0 000 16zm0 14a6 6 0 110-12 6 6 0 000 12zm-1-9a1 1 0 100-2 0v5a1 1 0 001 2h2a1 1 0 001-2v-5a1 1 0 000-2z"></path></svg>
                                </div>
                                <div class="font-bold text-indigo-600 mb-2 flex items-center gap-2">ü§ñ AI Analysis Result:</div>
                                <div id="typing-text" class="typing-cursor font-mono text-slate-600 leading-relaxed"></div>
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 rounded-2xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-3">
                                <span>Send Request to Admin</span> <span class="text-2xl">üìÖ</span>
                            </button>
                        </form>
                    </div>

                    <!-- Doctors List -->
                    <div class="bg-white rounded-3xl p-8 shadow-xl border border-slate-100">
                        <h3 class="font-bold text-xl text-slate-800 mb-6">Our Specialists</h3>
                        <div class="space-y-5">
                            ${DB.doctors.map(d => `
                                <div class="flex items-center gap-4 p-4 rounded-2xl bg-slate-50 hover:bg-indigo-50 transition-colors group border border-transparent hover:border-indigo-100">
                                        <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-3xl shadow-md group-hover:scale-110 transition-transform duration-300">üë®‚Äç‚öïÔ∏è</div>
                                        <div>
                                            <div class="font-bold text-slate-900 text-lg">${d.n}</div>
                                            <div class="text-sm text-slate-500 font-medium">${d.spec} Expert</div>
                                            <div class="flex items-center gap-1 mt-1">
                                                <span class="text-xs text-yellow-500 bg-yellow-50 px-2 py-0.5 rounded-full">‚òÖ</span>
                                                <span class="text-xs text-indigo-500">AI Recommended</span>
                                            </div>
                                        </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function analyzeSymptom(issue) {
            const box = document.getElementById('ai-hint');
            const txt = document.getElementById('typing-text');
            box.classList.remove('hidden');
            txt.innerHTML = '';
            
            const data = {
                'Fever': "Analysis: High viral load suspected. Immediate CBC recommended. Stay hydrated.",
                'Chest': "Analysis: Cardiac distress indicators detected. Immediate ECG required.",
                'Fracture': "Analysis: Orthopedic injury. Immobilization critical. X-Ray ordered."
            };
            
            const message = data[issue] || "Waiting for input...";
            let i = 0;
            box.style.opacity = 1;
            
            const interval = setInterval(() => {
                txt.innerHTML = message.substring(0, i+1);
                i++;
                if(i >= message.length) clearInterval(interval);
            }, 25);
        }

        function bookAppt(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const original = btn.innerHTML;
            
            btn.innerHTML = `<span class="animate-spin inline-block mr-2">‚åõ</span> Sending Request...`;
            btn.disabled = true;
            
            setTimeout(() => {
                // Robust Value Retrieval
                const pName = currentUser.n; 
                const pAge = document.getElementById('p-age').value;
                const pPhone = document.getElementById('p-phone').value;
                const pIssue = document.getElementById('p-issue').value;

                if(!pAge || !pPhone || !pIssue) {
                    showToast('Missing Details', 'error');
                    btn.innerHTML = original;
                    btn.disabled = false;
                    return;
                }

                const newAppt = {
                    id: Date.now(),
                    u: currentUser.u,
                    n: pName,
                    age: pAge,
                    phone: pPhone,
                    issue: pIssue,
                    status: 'pending',
                    level: null,
                    vitals: null,
                    disease: null,
                    bed: null,
                    doc: null
                };

                DB.appointments.push(newAppt);
                saveDB(); // Try Save

                showToast('Request Sent Successfully', 'success');
                
                // Reset UI
                btn.innerHTML = original;
                btn.disabled = false;
                document.getElementById('p-age').value = '';
                document.getElementById('p-phone').value = '';
                document.getElementById('p-issue').value = '';
                document.getElementById('ai-hint').classList.add('hidden');
                
                navigate('patient-dashboard');
            }, 1000);
        }

        // --- 5. VIEW: ADMIN (WITH TRIAGE LEVELS) ---
        function renderAdmin(c) {
            const pending = DB.appointments.filter(a => a.status === 'pending');
            const history = DB.appointments.filter(a => a.status !== 'pending').sort((a,b) => b.id - a.id);

            c.innerHTML = `
                <div class="flex justify-between items-end mb-10">
                    <h2 class="text-4xl font-extrabold text-slate-800">Admin Approvals</h2>
                    <span class="bg-indigo-100 text-indigo-700 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm animate-pulse-fast">${pending.length} Pending</span>
                </div>

                ${pending.length === 0 
                    ? `<div class="bg-white p-16 rounded-3xl text-center shadow-xl border border-slate-100 animate-fade-in">
                        <div class="text-5xl mb-4 opacity-40">üì≠</div>
                        <h3 class="text-xl font-bold text-slate-800">All Clear</h3>
                        <p class="text-slate-500 mt-2">No pending requests at the moment.</p>
                        <p class="text-xs text-slate-400 mt-2">Have a patient book an appointment to see it here.</p>
                       </div>`
                    : `<div class="grid lg:grid-cols-3 gap-6">
                        ${pending.map(a => `
                            <div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 hover:shadow-2xl transition-all duration-300 flex flex-col justify-between h-full relative overflow-hidden">
                                <div class="mb-6">
                                    <div class="flex justify-between items-start">
                                        <div class="font-bold text-xl text-slate-800">${a.n}</div>
                                        <span class="bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm border border-yellow-200">PENDING</span>
                                    </div>
                                    <div class="text-sm text-slate-500 space-y-2 bg-slate-50 p-3 rounded-2xl border border-slate-100">
                                        <div class="flex items-center gap-2"><span>üìû</span> ${a.phone}</div>
                                        <div class="flex items-center gap-2"><span>üéÇ</span> ${a.age} Years Old</div>
                                        <div class="mt-3 pt-3 border-t border-slate-100 border-dashed">
                                            Issue: <span class="font-bold text-slate-700 ml-2">${a.issue}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="approveReq(${a.id}, this)" class="w-full mt-auto bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-2xl transform active:scale-95 transition-all duration-200">
                                    Approve & Assign
                                </button>
                            </div>
                        `).join('')}
                      </div>`
                }

                <!-- Processed Requests (History with Levels) -->
                <h3 class="text-xl font-bold text-slate-700 mb-6 border-b-2 border-slate-100 pb-2">Processed Requests (Priority Levels)</h3>
                <div class="grid lg:grid-cols-3 gap-6">
                    ${history.length === 0 ? '<p class="col-span-full text-slate-500">No history yet.</p>' : history.map(a => `
                        <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 animate-fade-in">
                            <div class="flex justify-between items-center mb-4">
                                <div class="font-bold text-lg text-slate-800">${a.n}</div>
                                <span class="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded font-bold uppercase">${a.status}</span>
                            </div>
                            <div class="space-y-2 text-sm text-slate-600">
                                <div><span class="font-medium text-slate-800">Assigned Doc:</span> ${a.doc || '-'}</div>
                                <div><span class="font-medium text-slate-800">Diagnosis:</span> ${a.disease || '-'}</div>
                                <!-- NEW FEATURE: Priority Level Display -->
                                <div class="mt-3 pt-3 border-t border-slate-100 border-dashed">
                                    <span class="font-bold text-slate-700 block mb-1">Priority Level:</span> 
                                    <span class="ml-2 px-3 py-1 rounded text-xs font-bold ${getLevelColor(a.level)}">
                                        ${a.level || 'Diagnosing...'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getLevelColor(level) {
            if(!level) return 'bg-slate-100 text-slate-400';
            if(level.includes('Critical')) return 'bg-red-100 text-red-700 border border-red-200';
            if(level.includes('Urgent')) return 'bg-yellow-100 text-yellow-700 border border-yellow-200';
            return 'bg-green-100 text-green-700 border border-green-200';
        }

        function approveReq(id, btn) {
            const apt = DB.appointments.find(a => a.id === id);
            if(!apt) return;

            const doc = DB.doctors[Math.floor(Math.random() * DB.doctors.length)];
            
            btn.innerHTML = `<span class="animate-spin inline-block">‚åõ</span> Assigning...`;
            
            setTimeout(() => {
                apt.doc = doc.n;
                apt.status = 'accepted';
                
                // SAVE (with error handling)
                saveDB();

                showToast(`Assigned to ${doc.n}`, 'success');
                renderAdmin(document.getElementById('main-content'));
            }, 800);
        }

        // --- 6. VIEW: DOCTOR ---
        function renderDoctor(c) {
            const patients = DB.appointments.filter(a => a.status === 'accepted');
            c.innerHTML = `
                <h2 class="text-4xl font-extrabold text-slate-800 mb-10">AI Diagnosis Center</h2>
                ${patients.length === 0 
                    ? `<div class="bg-white p-16 rounded-3xl text-center shadow-xl border border-slate-100 animate-fade-in">
                        <div class="text-5xl mb-4 opacity-40">ü©∫</div>
                        <h3 class="text-xl font-bold text-slate-800">Waiting Room Empty</h3>
                        <p class="text-slate-500 mt-2">No assigned patients yet.</p>
                       </div>`
                    : `<div class="grid lg:grid-cols-2 gap-8">
                        ${patients.map(a => `
                            <div class="bg-white rounded-3xl p-8 shadow-xl border border-slate-100 hover:shadow-2xl transition-all duration-300">
                                <div class="flex justify-between items-center mb-6">
                                    <div class="font-bold text-2xl text-slate-800">${a.n}</div>
                                    <div class="text-xs text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full border border-indigo-100 font-bold tracking-wide">${a.doc}</div>
                                </div>
                                <div class="text-sm text-slate-500 mb-6">Assigned Doc: ${a.doc} | Issue: ${a.issue}</div>
                                
                                <div class="bg-slate-50 rounded-2xl p-5 mb-6 border border-slate-100">
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Enter Patient Vitals</div>
                                    <div class="flex gap-4">
                                        <div class="flex-1">
                                            <label class="text-sm font-medium text-slate-600 mb-1 ml-1">Heart Rate</label>
                                            <input type="number" id="hr-${a.id}" placeholder="bpm" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all duration-300 bg-white shadow-sm">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-sm font-medium text-slate-600 mb-1 ml-1">Temp</label>
                                            <input type="number" id="temp-${a.id}" placeholder="¬∞C" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all duration-300 bg-white shadow-sm">
                                        </div>
                                    </div>
                                </div>

                                <div id="result-${a.id}" class="hidden mb-6 animate-fade-in">
                                    <div class="bg-emerald-50/90 border border-emerald-200 rounded-2xl p-5 relative overflow-hidden">
                                        <div class="absolute top-0 right-0 p-2">
                                            <svg class="w-6 h-6 text-emerald-500 animate-pulse-fast" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100-16 8 8 0 000 16zm0 14a6 6 0 110-12 6 6 0 000 12zm-1-9a1 1 0 100-2 0v5a1 1 0 001 2h2a1 1 0 001-2v-5a1 1 0 000-2z"></path></svg>
                                        </div>
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="text-sm font-bold text-emerald-700 flex items-center gap-2">ü§ñ AI Analysis Result</div>
                                            <div class="text-xs text-emerald-600 font-mono bg-emerald-100 px-2 py-1 rounded-lg">98% CONFIDENCE</div>
                                        </div>
                                        <div class="w-full bg-emerald-200 rounded-full h-2.5 overflow-hidden mb-3">
                                            <div class="bg-emerald-500 h-full rounded-full" style="width: 0%; transition: width 1.5s ease-out;"></div>
                                        </div>
                                        <div id="disease-${a.id}" class="font-bold text-slate-800 text-xl">Analyzing...</div>
                                    </div>
                                </div>

                                <button onclick="runDiagnosis(${a.id}, this)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-2xl transform active:scale-95 transition-all duration-200 flex items-center justify-center gap-2">
                                    <span>Run AI Diagnosis</span> <span class="text-xl">üî¨</span>
                                </button>
                            </div>
                        `).join('')}
                      </div>`
                }
            `;
        }

        function runDiagnosis(id, btn) {
            const apt = DB.appointments.find(a => a.id === id);
            const hr = document.getElementById(`hr-${id}`).value;
            const temp = document.getElementById(`temp-${id}`).value;
            if(!hr || !temp) return showToast('Enter Vitals', 'error');

            const resBox = document.getElementById(`result-${id}`);
            
            btn.innerHTML = `<span class="animate-spin inline-block">‚åõ</span> AI Processing...`;
            btn.disabled = true;

            setTimeout(() => {
                let disease = "Viral Fever";
                let level = "Stable (ESI 3)";

                // AI Logic
                if(temp > 39 && hr > 100) { 
                    disease = "Sepsis / Critical"; 
                    level = "Critical (ESI 1)";
                }
                else if(hr > 110) { 
                    disease = "Tachycardia"; 
                    level = "Urgent (ESI 2)";
                }
                else if(temp > 38) {
                    disease = "High Grade Fever";
                    level = "Urgent (ESI 2)";
                }

                apt.disease = disease;
                apt.level = level; // SAVE LEVEL
                apt.vitals = { hr, temp };
                apt.status = 'diagnosed';

                resBox.classList.remove('hidden');
                
                setTimeout(() => {
                    resBox.querySelector('.bg-emerald-500').style.width = '98%';
                    document.getElementById(`disease-${id}`).innerText = disease;
                }, 100);

                showToast(`Diagnosed: ${disease}`, 'success');
                setTimeout(() => renderDoctor(document.getElementById('main-content')), 2000);
            }, 1500);
        }

        // --- 7. VIEW: NURSE (DETAILED BED MAP) ---
        function renderNurse(c) {
            const patients = DB.appointments.filter(a => a.status === 'diagnosed');
            const bestBed = DB.beds.find(b => b.status === 'free');

            c.innerHTML = `
                <h2 class="text-4xl font-extrabold text-slate-800 mb-8">Smart Bed Management</h2>
                
                <!-- AI Scanner Visual -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-3xl p-6 mb-10 shadow-xl text-white relative overflow-hidden">
                    <div class="absolute -right-6 -bottom-6 text-9xl opacity-10">üõèÔ∏è</div>
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="bg-white/20 p-3 rounded-2xl backdrop-blur-sm">
                            <svg class="w-10 h-10 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                        <div>
                            <div class="font-bold text-xl">AI Hospital Bed Optimizer</div>
                            <div class="text-blue-100 text-sm">Scanning hospital database for optimal placement...</div>
                        </div>
                    </div>
                </div>

                ${patients.length === 0 
                    ? `<div class="bg-white p-16 rounded-3xl text-center shadow-xl border border-slate-100">
                        <div class="text-5xl mb-4 opacity-40">üè•</div>
                        <h3 class="text-xl font-bold text-slate-800">No Patients Waiting</h3>
                        <p class="text-slate-500 mt-2">All diagnosed patients have been admitted.</p>
                       </div>`
                    : `<div class="grid lg:grid-cols-2 gap-8">
                        <!-- Patient List -->
                        <div class="col-span-1">
                            ${patients.map(a => `
                                <div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 mb-6 animate-fade-in">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="font-bold text-lg text-slate-800">${a.n}</div>
                                        <div class="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded-full border border-indigo-100 font-bold">DIAGNOSED</div>
                                    </div>
                                    <div class="text-sm text-slate-500 space-y-2 mb-4 bg-slate-50 p-3 rounded-2xl border border-slate-100">
                                        <div>Diagnosis: <span class="font-bold text-red-600">${a.disease}</span></div>
                                        <div class="flex gap-4">
                                            <span>HR: <span class="font-medium">${a.vitals.hr}</span></span> ‚Ä¢ 
                                            <span>Temp: <span class="font-medium">${a.vitals.temp}¬∞C</span></span>
                                        </div>
                                        <div>Phone: ${a.phone}</div>
                                    </div>
                                    
                                    <div id="bed-res-${a.id}" class="hidden bg-blue-50 border border-blue-100 rounded-2xl p-3 mb-4 text-sm text-blue-800 flex items-center gap-2">
                                        <span class="animate-pulse">üîç</span> <span id="bed-txt-${a.id}">Scanning Hospital DB...</span>
                                    </div>

                                    <button onclick="assignBed(${a.id}, this)" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-2xl shadow-md hover:shadow-lg transform active:scale-95 transition-all duration-200">
                                        Allocate AI Suggested Bed
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        </div>

                        <!-- ALL BED DETAILS (Expanded Grid) -->
                        <div class="col-span-1 bg-white rounded-3xl p-6 shadow-xl border border-slate-100 h-fit animate-fade-in">
                            <h3 class="font-bold text-lg text-slate-700 mb-4 border-b-2 border-slate-100 pb-2">Hospital Bed Map (E1-E20)</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                ${DB.beds.map(b => {
                                    const isFree = b.status === 'free';
                                    const isSuggested = bestBed && b.id === bestBed.id;
                                    
                                    // Occupant Text Logic
                                    let occupantText = "Available";
                                    let occupantClass = "font-medium";
                                    if(!isFree) {
                                        const p = DB.appointments.find(pat => pat.bed === b.id);
                                        if(p) {
                                            occupantText = p.n;
                                            occupantClass = "font-bold text-indigo-600";
                                        } else {
                                            occupantText = "Maintenance";
                                            occupantClass = "text-slate-400";
                                        }
                                    }

                                    let classes = "rounded-xl p-3 flex flex-col items-center justify-center border-2 transition-all duration-300 text-sm font-bold relative h-24 ";
                                    
                                    if(isSuggested) classes += " ai-bed-highlight border-indigo-500 bg-indigo-50 text-indigo-700 shadow-lg scale-105 ";
                                    else if(isFree) classes += "border-emerald-200 bg-emerald-50 text-emerald-700 hover:scale-105 cursor-pointer hover:shadow-md hover:bg-emerald-100 ";
                                    else classes += "border-slate-200 bg-slate-100 text-slate-400 opacity-50 cursor-not-allowed ";

                                    return `
                                        <div class="${classes}">
                                            <div class="text-xl mb-1">${b.label}</div>
                                            <div class="text-[10px] mt-1 uppercase tracking-wider font-medium mb-2">${b.status}</div>
                                            <div class="text-[10px] font-medium leading-tight">${occupantText}</div>
                                            ${isSuggested ? `<div class="absolute -top-2 -right-2 bg-indigo-600 text-white text-[10px] px-1.5 py-0.5 rounded-full shadow-md animate-pulse-fast border border-indigo-300">AI PICK</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                      </div>`
                }
            `;
        }

        function assignBed(id, btn) {
            const apt = DB.appointments.find(a => a.id === id);
            const freeBed = DB.beds.find(b => b.status === 'free');
            const resBox = document.getElementById(`bed-res-${id}`);
            const resTxt = document.getElementById(`bed-txt-${id}`);
            
            resBox.classList.remove('hidden');
            btn.innerHTML = `<span class="animate-spin inline-block">‚åõ</span> Allocating...`;
            btn.disabled = true;

            setTimeout(() => {
                if(freeBed) {
                    resBox.innerHTML = `<span class="text-emerald-600 font-bold">‚úÖ Suggested: Bed ${freeBed.id}</span>`;
                    
                    // Update Data
                    apt.bed = freeBed.id;
                    
                    // Update Bed Status
                    const bedIndex = DB.beds.findIndex(b => b.id === freeBed.id);
                    DB.beds[bedIndex].status = 'occupied';
                    DB.beds[bedIndex].patientId = apt.n; // Store patient name in bed object
                    
                    apt.status = 'admitted';
                    
                    // Save
                    saveDB();

                    showToast(`Allocated Bed ${freeBed.id}`, 'success');
                    setTimeout(() => renderNurse(document.getElementById('main-content')), 1500);
                } else {
                    resTxt.innerText = "‚ùå No Free Beds Available";
                    resBox.classList.add('bg-red-50', 'border-red-100', 'text-red-600');
                    showToast('No beds available', 'error');
                    btn.disabled = false;
                    btn.innerHTML = 'Retry';
                }
            }, 1000);
        }

        // --- CHATBOT ---
        function toggleChat() { 
            const win = document.getElementById('chat-window');
            win.classList.toggle('open'); 
        }
        function sendChat() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt) return;
            
            const body = document.getElementById('chat-messages');
            body.innerHTML += `<div class="ml-auto bg-indigo-600 text-white rounded-2xl rounded-br-none p-4 text-sm shadow-md max-w-[85%] animate-slide-up">${txt}</div>`;
            inp.value = '';
            body.scrollTop = body.scrollHeight;

            setTimeout(() => {
                let reply = "I am here to help.";
                if(txt.toLowerCase().includes('fever')) reply = "High fever can be dangerous. Please monitor temperature.";
                if(txt.toLowerCase().includes('appointment')) reply = "Use the 'My Health' tab to book.";
                if(txt.toLowerCase().includes('doctor')) reply = "We have specialists in Cardiology and Orthopedics.";
                if(txt.toLowerCase().includes('bed')) reply = "Nurses manage bed allocation automatically via AI.";
                
                body.innerHTML += `<div class="mr-auto bg-white text-slate-800 rounded-2xl rounded-bl-none p-4 text-sm shadow-sm border border-slate-100 max-w-[85%] animate-slide-up">${reply}</div>`;
                body.scrollTop = body.scrollHeight;
            }, 600);
        }

        // --- TOAST ---
        function showToast(msg, type) {
            const area = document.getElementById('toast-area');
            const t = document.createElement('div');
            
            if(type === 'success') {
                t.className = "bg-slate-800 text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-3 animate-slide-up border border-emerald-500";
            } else {
                t.className = "bg-red-500 text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-3 animate-slide-up border border-red-200";
            }
            
            t.innerHTML = `<span class="text-2xl">${type==='success'?'‚úÖ':'‚ö†Ô∏è'}</span> <span class="font-semibold text-lg">${msg}</span>`;
            area.appendChild(t);
            
            setTimeout(() => {
                t.style.opacity = '0'; 
                t.style.transform = 'translateY(20px)';
                setTimeout(() => t.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
