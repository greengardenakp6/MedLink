<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MedLink AI - Patient Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FIREBASE SDKS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
     if("serviceWorker" in navigator){
         navigator.serviceWorker.register("service-worker.js").catch(err => console.log("SW Error: ", err));
     }
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4f46e5', secondary: '#64748b', success: '#10b981', warning: '#f59e0b', danger: '#ef4444' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'slide-up': 'slideUp 0.4s ease-out', 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { margin: 0; overflow-x: hidden; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .typing-cursor::after { content: '|'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        
        /* Bed Highlights */
        .ai-bed-highlight { animation: highlightPulse 2s infinite; border-color: #4f46e5; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); transform: scale(1.05); z-index: 10; }
        .ai-bed-highlight-rough { animation: highlightPulseRough 2s infinite; border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); transform: scale(1.05); z-index: 10; }
        @keyframes highlightPulse { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
        @keyframes highlightPulseRough { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        #chat-window { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* Emergency Stripe Animation */
        .ambulance-alert-bg {
            background: repeating-linear-gradient(45deg, #fee2e2, #fee2e2 10px, #fecaca 10px, #fecaca 20px);
            animation: moveStripes 1s linear infinite;
        }
        @keyframes moveStripes {
            0% { background-position: 0 0; }
            100% { background-position: 28px 0; }
        }
        
        /* Red Pulse */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 30px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .pulse-red { animation: pulse-red 2s infinite; }

        /* Mobile Sidebar Transition */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen w-screen overflow-hidden">

    <!-- ================= EMERGENCY OVERLAY ================= -->
    <div id="emergency-overlay" class="fixed inset-0 z-[100] bg-red-700 hidden flex flex-col items-center justify-center text-white transition-opacity duration-500 backdrop-blur-sm">
        <div id="emergency-content" class="text-center relative z-10 p-8 max-w-2xl w-full"></div>
        <div class="absolute inset-0 bg-red-600 pulse-red pointer-events-none"></div>
    </div>

    <!-- ================= AUTH SCREEN ================= -->
    <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-4">
        <div class="bg-white/90 backdrop-blur-md p-6 md:p-8 rounded-3xl shadow-2xl w-full max-w-md animate-fade-in border border-white/50">
            <div class="text-center mb-8">
                <div class="text-5xl md:text-6xl mb-4 animate-pulse-fast">üè•</div>
                <h1 class="text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">MedLink AI</h1>
                <p class="text-slate-500 mt-2 text-sm">Live Cloud Connected</p>
            </div>
            <div class="flex bg-slate-200/50 p-1 rounded-xl mb-8 relative">
                <div id="switch-bg" class="absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-white shadow-sm rounded-lg transition-all duration-300"></div>
                <button id="tab-login" onclick="setAuthMode('login')" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all duration-300 relative z-10 text-indigo-600">Login</button>
                <button id="tab-signup" onclick="setAuthMode('signup')" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all duration-300 relative z-10 text-slate-500">Sign Up</button>
            </div>
            <form onsubmit="handleAuth(event)" class="space-y-4">
                <div id="role-select" class="hidden grid grid-cols-4 gap-2 mb-4">
                    <button type="button" onclick="selectRole('patient', this)" class="role-card group relative overflow-hidden border-2 border-slate-200 rounded-xl p-2 flex flex-col items-center gap-1 transition-all duration-300 hover:shadow-lg bg-white">
                        <div class="text-lg">üë§</div>
                        <div class="font-bold text-slate-700 text-[10px]">Patient</div>
                    </button>
                    <button type="button" onclick="selectRole('admin', this)" class="role-card group relative overflow-hidden border-2 border-slate-200 rounded-xl p-2 flex flex-col items-center gap-1 transition-all duration-300 hover:shadow-lg bg-white">
                        <div class="text-lg">‚öñÔ∏è</div>
                        <div class="font-bold text-slate-700 text-[10px]">Admin</div>
                    </button>
                    <button type="button" onclick="selectRole('doctor', this)" class="role-card group relative overflow-hidden border-2 border-slate-200 rounded-xl p-2 flex flex-col items-center gap-1 transition-all duration-300 hover:shadow-lg bg-white">
                        <div class="text-lg">ü©∫</div>
                        <div class="font-bold text-slate-700 text-[10px]">Doctor</div>
                    </button>
                    <button type="button" onclick="selectRole('nurse', this)" class="role-card group relative overflow-hidden border-2 border-slate-200 rounded-xl p-2 flex flex-col items-center gap-1 transition-all duration-300 hover:shadow-lg bg-white">
                        <div class="text-lg">üè•</div>
                        <div class="font-bold text-slate-700 text-[10px]">Nurse</div>
                    </button>
                </div>
                <div class="space-y-2">
                    <input type="text" id="username" placeholder="Username" required class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all duration-300 bg-white/50 text-base">
                    <input type="password" id="password" placeholder="Password" required class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all duration-300 bg-white/50 text-base">
                </div>

                <!-- SIGNUP SPECIFIC -->
                <div id="signup-fields" class="hidden space-y-3">
                    <input type="tel" id="phone" placeholder="Phone Number (+1 234...)" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all duration-300 bg-white/50 text-base">
                    <div id="recaptcha-container"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="otp-input" placeholder="Enter OTP" maxlength="6" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none transition-all bg-white text-center font-bold tracking-widest">
                        <button type="button" onclick="requestOTP()" id="get-otp-btn" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold transition-colors text-sm">Get OTP</button>
                    </div>
                    <div class="text-[10px] text-slate-400 text-center">SMS sent to your phone.</div>
                </div>

                <!-- CAPTCHA SECTION (LOGIN) -->
                <div id="captcha-container" class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Security Check</label>
                    <div class="flex gap-2">
                        <canvas id="captchaCanvas" width="120" height="40" class="bg-slate-100 rounded-lg border border-slate-200 cursor-pointer" title="Click to reload"></canvas>
                        <button type="button" onclick="drawCaptcha()" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 transition-colors" title="Reload Captcha">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                    <input type="text" id="captcha-input" placeholder="Enter Captcha" class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none transition-all bg-white text-sm uppercase">
                </div>

                <button type="submit" id="auth-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center gap-2 mt-4">
                    <span id="auth-btn-text">Login</span>
                </button>
            </form>
            <div id="storage-status" class="mt-4 text-xs text-center text-slate-400">
                Status: <span id="status-text" class="font-bold text-indigo-600">Local Mode</span>
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP ================= -->
    <div id="app-container" class="hidden flex h-full w-full relative">
        
        <!-- MOBILE HEADER -->
        <div class="md:hidden fixed top-0 left-0 right-0 h-16 bg-white border-b border-slate-200 z-40 flex items-center justify-between px-4 shadow-sm">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ü©∫</span>
                <span class="font-bold text-lg text-slate-800">MedLink AI</span>
            </div>
            <button onclick="toggleSidebar()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-white border-r border-slate-100 flex flex-col shadow-xl transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 sidebar-transition">
            <div class="md:hidden flex justify-end p-4 border-b border-slate-100">
                <button onclick="toggleSidebar()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-8 hidden md:flex items-center gap-4 border-b border-slate-50">
                <div class="text-3xl">ü©∫</div>
                <div class="font-bold text-2xl text-slate-800 tracking-tight">MedLink AI</div>
            </div>
            <nav id="nav-menu" class="flex-1 p-6 space-y-3 overflow-y-auto"></nav>
            <div class="p-6 border-t border-slate-100 bg-slate-50/50">
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-inner">
                    <div id="user-name" class="font-bold text-slate-800 text-lg truncate">User</div>
                    <div id="user-role" class="text-xs text-indigo-500 font-semibold uppercase tracking-widest mt-0.5">Role</div>
                </div>
                <button onclick="logout()" class="w-full mt-6 py-3 text-sm text-red-500 font-bold bg-red-50 hover:bg-red-100 rounded-xl transition-colors"> Logout </button>
            </div>
        </aside>

        <!-- OVERLAY for Mobile Sidebar -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 bg-slate-50/80 h-full overflow-y-auto hide-scrollbar relative pt-16 md:pt-0">
            <div id="main-content" class="p-4 md:p-8 max-w-8xl mx-auto min-h-full pb-24 md:pb-8"></div>
        </main>
    </div>

    <!-- ================= CHATBOT ================= -->
    <div class="fixed bottom-4 md:bottom-8 right-4 md:right-8 z-40 flex flex-col items-end pointer-events-none">
        <div id="chat-window" class="hidden pointer-events-auto absolute bottom-20 md:bottom-24 right-0 w-[90vw] md:w-96 h-[70vh] md:h-[600px] bg-white rounded-3xl shadow-2xl border border-slate-100 overflow-hidden flex flex-col scale-95 opacity-0 origin-bottom-right mb-4">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white rounded-t-3xl cursor-pointer shadow-md">
                <div class="font-bold flex items-center gap-2">ü§ñ MedTriage Bot <span class="text-xs bg-white/20 px-2 py-0.5 rounded-full">AI</span></div>
                <button onclick="toggleChat()" class="hover:bg-indigo-700 p-1.5 rounded-full transition-colors text-xl leading-none">&times;</button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50 space-y-3 scroll-smooth">
                <div class="mr-auto bg-white text-slate-800 rounded-2xl rounded-bl-none p-4 text-sm shadow-sm border border-slate-100 max-w-[90%] animate-slide-up">
                    <p class="font-bold text-indigo-600 mb-1">Hello! I am MedTriage.</p>
                    <p class="text-sm">Describe your symptoms (e.g., "I have headache and fever"). <br><span class="text-xs text-slate-400 mt-1 block italic">Use Mic for Voice.</span></p>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-white flex gap-3">
                <button id="voice-btn" onclick="startVoiceInput()" class="w-11 h-11 rounded-full bg-slate-100 hover:bg-indigo-100 text-slate-500 hover:text-indigo-600 transition-colors flex items-center justify-center shrink-0" title="Voice Input">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </button>
                <input type="text" id="chat-input" placeholder="Describe symptoms..." onkeypress="if(event.key==='Enter')sendChat()" class="flex-1 bg-slate-50 border-none rounded-full px-5 py-3 text-sm focus:ring-2 focus:ring-indigo-100 outline-none transition-all shadow-inner">
                <button onclick="sendChat()" class="bg-indigo-600 hover:bg-indigo-700 text-white w-11 h-11 rounded-full flex items-center justify-center transition-transform active:scale-95 shadow-md hover:shadow-xl shrink-0">‚û§</button>
            </div>
        </div>

        <button id="chat-toggle-btn" onclick="toggleChat()" class="pointer-events-auto w-14 h-14 md:w-16 md:h-16 bg-indigo-600 text-white rounded-full shadow-2xl hover:shadow-3xl hover:scale-105 active:scale-95 transition-all duration-300 flex items-center justify-center text-2xl md:text-3xl animate-pulse-fast border-4 border-indigo-200 ring-2 ring-indigo-200">üí¨</button>
    </div>

    <div id="toast-area" class="fixed bottom-24 md:bottom-8 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2 pointer-events-none w-full max-w-sm px-4 items-center"></div>

    <script>
        // --- 1. FIREBASE & CONFIG ---
        const firebaseConfig = {
            apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: ""
        };

        let auth = null, db = null, isCloudConnected = false;

        try {
            if (firebaseConfig.apiKey && firebaseConfig.projectId) {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.database();
                isCloudConnected = true;
                document.getElementById('status-text').innerText = "üü¢ Cloud Connected";
                document.getElementById('status-text').className = "font-bold text-green-600";
            } else {
                document.getElementById('status-text').innerText = "üü° Demo Mode";
                document.getElementById('status-text').className = "font-bold text-orange-500";
            }
        } catch (e) { console.error("Firebase Init Error", e); }

        // --- 2. DATA ---
        const defaultDB = {
            users: [
                { u: 'admin', p: '123', r: 'admin', n: 'Admin User' },
                { u: 'doc', p: '123', r: 'doctor', n: 'Dr. Strange' },
                { u: 'nurse', p: '123', r: 'nurse', n: 'Joy Nurse' },
                { u: 'pat', p: '123', r: 'patient', n: 'John Doe' }
            ],
            doctors: [{ n: "Dr. Sarah", spec: "Cardiology" }, { n: "Dr. Alan", spec: "Orthopedics" }, { n: "Dr. Ellie", spec: "General" }],
            beds: Array.from({length:20}, (_,i)=>({ id: i+1, label: `E${i+1}`, status: i<5 ? 'occupied' : 'free', patientId: i<5 ? `P-${100+i}` : null })),
            roughBeds: Array.from({length:5}, (_,i)=>({ id: `R${i+1}`, label: `R${i+1}`, status: i<1 ? 'occupied' : 'free', patientId: i<1 ? `T-${900+i}` : null })),
            appointments: []
        };
        
        // --- EXPANDED MEDICAL KNOWLEDGE BASE ---
        const MEDICAL_KNOWLEDGE_BASE = [
            { 
                keywords: ['chest pain', 'heart attack', 'cardiac', 'breathing difficulty', 'breath', 'heart pain'],
                condition: "Cardiac / Respiratory Distress",
                solution: "This is potentially critical. Sit down and rest immediately.",
                meds: "Take Aspirin 325mg if not allergic and no history of ulcers.",
                warning: "CALL 911 IMMEDIATELY. Do not drive yourself.",
                urgency: 'critical'
            },
            { 
                keywords: ['fever', 'temperature', 'hot', 'chills', 'shivering'],
                condition: "Fever / Infection",
                solution: "Hydrate with water or electrolytes. Rest in a cool place. Sponge bath with lukewarm water.",
                meds: "Paracetamol (Acetaminophen) 500mg every 4-6 hours. Ibuprofen 400mg if not allergic.",
                warning: "If fever >39.5¬∞C or lasts >3 days, visit a clinic.",
                urgency: 'high'
            },
            { 
                keywords: ['headache', 'migraine', 'head pain', 'head hurts'],
                condition: "Headache / Migraine",
                solution: "Rest in a dark, quiet room. Hydrate well. Massage temples gently.",
                meds: "Paracetamol 500mg or Ibuprofen 400mg.",
                warning: "If vision blurs, neck stiffens, or speech slurs, go to ER.",
                urgency: 'medium'
            },
            { 
                keywords: ['stomach', 'abdomen', 'nausea', 'vomit', 'gastric', 'indigestion'],
                condition: "Gastric Distress",
                solution: "Eat light foods (toast, rice). Avoid spicy/oily meals. Hydrate slowly.",
                meds: "Antacids (Gaviscon/Tums) or Omeprazole for acidity.",
                warning: "If blood in vomit or severe pain, seek immediate care.",
                urgency: 'medium'
            },
            { 
                keywords: ['fracture', 'broken bone', 'leg pain', 'arm pain', 'swelling', 'sprain'],
                condition: "Musculoskeletal Injury",
                solution: "Apply ice pack wrapped in cloth. Elevate the limb. Immobilize the area.",
                meds: "Ibuprofen or Naproxen for pain and swelling.",
                warning: "If bone is visible or limb is deformed, do not move. Call emergency.",
                urgency: 'high'
            },
            { 
                keywords: ['cold', 'cough', 'flu', 'sneeze', 'running nose', 'sore throat'],
                condition: "Common Cold / Flu",
                solution: "Warm fluids (soup, tea). Gargle salt water for throat. Rest well.",
                meds: "Decongestants (Pseudoephedrine) or Cough syrup. Vitamin C.",
                warning: "If high fever or difficulty breathing, consult a doctor.",
                urgency: 'low'
            },
            { 
                keywords: ['cut', 'bleeding', 'wound', 'blood', 'injury'],
                condition: "Laceration / Wound",
                solution: "Apply firm pressure with clean cloth. Clean with water.",
                meds: "Apply antibiotic ointment (Neosporin) and bandage.",
                warning: "If bleeding doesn't stop after 10 mins, get stitches.",
                urgency: 'high'
            },
            { 
                keywords: ['allergy', 'itching', 'rash', 'hives', 'swollen face'],
                condition: "Allergic Reaction",
                solution: "Move away from potential allergen. Wash area if contact allergy.",
                meds: "Antihistamines (Cetirizine or Diphenhydramine).",
                warning: "If throat swells or breathing issues, use EpiPen and call 911.",
                urgency: 'high'
            },
            { 
                keywords: ['stress', 'anxiety', 'panic', 'depressed', 'mental'],
                condition: "Mental Health / Stress",
                solution: "Practice deep breathing (4-7-8 technique). Take a walk. Talk to someone.",
                meds: "Mild herbal teas (Chamomile). Consult doctor for prescriptions.",
                warning: "If thoughts of self-harm, call helpline immediately.",
                urgency: 'medium'
            }
        ];


        let DB = { ...defaultDB }; 
        let currentUser = null;
        let authMode = 'login';
        let selectedRole = 'patient';
        let windowConfirmationResult = null;
        
        const HOSPITALS = [
            { name: "City General Hospital", loc: "Downtown District", dist: "1.2 km", rating: 4.8, icon: "üèôÔ∏è" },
            { name: "St. Mary's Medical Center", loc: "Westside", dist: "4.5 km", rating: 4.5, icon: "‚õ™" },
            { name: "Unity Health Center", loc: "North Hills", dist: "2.8 km", rating: 4.7, icon: "ü§ù" },
            { name: "Sunrise Children's Hospital", loc: "Suburbs", dist: "8.1 km", rating: 4.9, icon: "üåÖ" }
        ];

        function saveDB() {
            if (isCloudConnected && db) { db.ref('hospitalData').set(DB); } 
            else { try { localStorage.setItem('medlink_live_v1', JSON.stringify(DB)); } catch(e){} }
        }
        function loadAndListen() {
            const stored = localStorage.getItem('medlink_live_v1');
            if (stored && !isCloudConnected) DB = { ...defaultDB, ...JSON.parse(stored) };
            if (isCloudConnected && db) {
                db.ref('hospitalData').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        DB = data;
                        if (currentUser && document.getElementById('app-container').classList.contains('hidden') === false) {
                            const activeLink = document.querySelector('#nav-menu a.bg-indigo-50');
                            if (activeLink) { const viewId = activeLink.id.replace('nav-', ''); navigate(viewId); }
                        }
                    }
                });
            }
        }
        loadAndListen();

        // --- AUTH LOGIC ---
        function setAuthMode(mode) {
            authMode = mode;
            const bg = document.getElementById('switch-bg');
            const loginTab = document.getElementById('tab-login');
            const signupTab = document.getElementById('tab-signup');
            const roleDiv = document.getElementById('role-select');
            const btnText = document.getElementById('auth-btn-text');
            const captchaDiv = document.getElementById('captcha-container');
            const signupDiv = document.getElementById('signup-fields');
            
            document.getElementById('username').value = "";
            document.getElementById('password').value = "";
            document.getElementById('captcha-input').value = "";
            document.getElementById('otp-input').value = "";
            windowConfirmationResult = null;

            if (mode === 'login') {
                bg.style.left = '4px';
                loginTab.classList.add('text-indigo-600'); loginTab.classList.remove('text-slate-500');
                signupTab.classList.remove('text-indigo-600'); signupTab.classList.add('text-slate-500');
                roleDiv.classList.add('hidden');
                btnText.innerText = 'Login';
                captchaDiv.classList.remove('hidden');
                signupDiv.classList.add('hidden');
                drawCaptcha(); 
            } else {
                bg.style.left = 'calc(50% + 4px)';
                signupTab.classList.add('text-indigo-600'); signupTab.classList.remove('text-slate-500');
                loginTab.classList.remove('text-indigo-600'); loginTab.classList.add('text-slate-500');
                roleDiv.classList.remove('hidden'); roleDiv.classList.add('animate-fade-in');
                btnText.innerText = 'Create Account';
                captchaDiv.classList.add('hidden');
                signupDiv.classList.remove('hidden');
            }
        }

        function requestOTP() {
            const phone = document.getElementById('phone').value.trim();
            if (!phone) { showToast("Enter phone number", 'warning'); return; }
            const btn = document.getElementById('get-otp-btn');
            btn.disabled = true; btn.innerText = "Sending...";
            
            // Firebase Logic omitted for brevity - uses Demo Mode logic primarily
            runDemoOTP(); // Switched to Demo for immediate testing
        }

        function runDemoOTP() {
            const btn = document.getElementById('get-otp-btn');
            btn.disabled = true; btn.innerText = "Generating...";
            setTimeout(() => {
                const generatedOTP = "123456"; // Fixed for testing
                windowConfirmationResult = {
                    confirm: (code) => code === generatedOTP 
                        ? Promise.resolve({ user: { uid: 'demo_user_' + Date.now() } }) 
                        : Promise.reject({ code: 'auth/invalid-verification-code' })
                };
                showToast(`DEMO OTP: ${generatedOTP}`, 'info');
                btn.disabled = false; btn.innerText = "Get OTP (Demo)";
            }, 1000);
        }

        function handleAuth(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const btn = document.getElementById('auth-btn');
            
            if (!u || !p) { showToast('Please fill all fields', 'error'); return; }

            if (authMode === 'login') {
                const captchaInput = document.getElementById('captcha-input').value.toUpperCase();
                if (captchaInput !== currentCaptcha) {
                    showToast('Invalid Captcha. Try again.', 'error');
                    drawCaptcha();
                    return;
                }
                const user = DB.users.find(x => x.u === u && x.p === p);
                if (user) { currentUser = user; enterApp(); } 
                else { showToast('Invalid Credentials', 'error'); }
            } else { 
                const otpInput = document.getElementById('otp-input').value.trim();
                if (!windowConfirmationResult) { showToast('Request OTP first.', 'warning'); return; }
                windowConfirmationResult.confirm(otpInput)
                    .then((result) => {
                        if (DB.users.find(x => x.u === u)) { showToast('Username exists', 'error'); return; }
                        btn.innerHTML = `<span class="animate-spin inline-block mr-2">‚åõ</span> Creating...`;
                        btn.disabled = true;
                        setTimeout(() => {
                            const newUser = { u, p, r: selectedRole, n: u, phone: document.getElementById('phone').value };
                            DB.users.push(newUser); saveDB();
                            currentUser = newUser;
                            showToast('Account Created', 'success');
                            enterApp();
                        }, 800);
                    })
                    .catch(() => showToast('Invalid OTP', 'error'));
            }
        }

        let currentCaptcha = "";
        function drawCaptcha() {
            const canvas = document.getElementById('captchaCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f1f5f9';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 5; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            currentCaptcha = code;
            ctx.font = 'bold 24px Arial';
            ctx.textBaseline = 'middle';
            for(let i=0; i<code.length; i++) {
                ctx.save();
                ctx.fillStyle = `hsl(${Math.random()*360}, 60%, 50%)`;
                ctx.translate(15 + i*20, 20);
                ctx.rotate((Math.random() - 0.5) * 0.4);
                ctx.fillText(code[i], 0, 0);
                ctx.restore();
            }
        }

        function selectRole(role, btn) {
            selectedRole = role;
            document.querySelectorAll('.role-card').forEach(b => { b.classList.remove('border-indigo-500', 'ring-2', 'ring-indigo-200', 'bg-indigo-50'); b.classList.add('border-slate-200'); });
            btn.classList.remove('border-slate-200');
            btn.classList.add('border-indigo-500', 'ring-2', 'ring-indigo-200', 'bg-indigo-50');
        }
        function enterApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-name').innerText = currentUser.n;
            document.getElementById('user-role').innerText = currentUser.r.toUpperCase();
            initMenu();
            if (currentUser.r === 'patient') navigate('patient-dashboard');
            else navigate(currentUser.r + '-dashboard');
        }
        function logout() { location.reload(); }

        // --- NAVIGATION ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function initMenu() {
            const menu = document.getElementById('nav-menu');
            menu.innerHTML = '';
            const routes = [
                { id: 'patient-dashboard', label: 'My Health', icon: 'üëã', roles: ['patient'] },
                { id: 'admin-dashboard', label: 'Requests', icon: 'üìã', roles: ['admin'] },
                { id: 'doctor-dashboard', label: 'Diagnose AI', icon: 'ü©∫', roles: ['doctor'] },
                { id: 'nurse-dashboard', label: 'Smart Beds', icon: 'üõèÔ∏è', roles: ['nurse'] }
            ];
            routes.forEach(r => {
                if (r.roles.includes(currentUser.r)) {
                    const item = document.createElement('a');
                    item.href = "#";
                    item.id = 'nav-' + r.id;
                    item.className = 'flex items-center gap-3 px-5 py-3 text-sm font-medium text-slate-600 rounded-xl transition-all duration-300 hover:bg-indigo-50 hover:text-indigo-600 group';
                    item.innerHTML = `<span class="text-2xl group-hover:scale-110 transition-transform">${r.icon}</span> <span class="font-semibold">${r.label}</span>`;
                    item.onclick = (e) => { e.preventDefault(); navigate(r.id); if(window.innerWidth < 768) toggleSidebar(); };
                    menu.appendChild(item);
                }
            });
        }
        function navigate(viewId) {
            document.querySelectorAll('#nav-menu a').forEach(a => a.classList.remove('bg-indigo-50', 'text-indigo-600'));
            const activeLink = document.getElementById('nav-' + viewId);
            if(activeLink) activeLink.classList.add('bg-indigo-50', 'text-indigo-600');
            const content = document.getElementById('main-content');
            content.classList.remove('animate-fade-in');
            void content.offsetWidth; 
            content.classList.add('animate-fade-in');
            if (viewId === 'patient-dashboard') renderPatient(content);
            else if (viewId === 'admin-dashboard') renderAdmin(content);
            else if (viewId === 'doctor-dashboard') renderDoctor(content);
            else if (viewId === 'nurse-dashboard') renderNurse(content);
        }

        // --- PATIENT VIEW ---
        function renderPatient(c) {
            c.innerHTML = `
            <div class="mb-6">
                <h2 class="text-2xl md:text-4xl font-extrabold text-slate-800 tracking-tight">Welcome Back, <span class="text-indigo-600">${currentUser.n}</span></h2>
                <p class="text-slate-500 text-sm md:text-base">Manage your health, book appointments, or perform a quick self-check.</p>
            </div>
            <div class="mb-8 rounded-2xl overflow-hidden shadow-lg border-2 border-red-500 animate-fade-in cursor-pointer hover:shadow-2xl transition-shadow" onclick="startEmergencyProtocol()">
                <div class="ambulance-alert-bg p-1"></div>
                <div class="bg-red-600 p-4 flex items-center justify-between text-white relative z-10">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-3 rounded-full animate-pulse">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                        <div>
                            <div class="font-bold text-lg leading-tight">Emergency Ambulance</div>
                            <div class="text-xs text-red-100 font-mono tracking-widest hidden sm:block">SMART AI TRIGGERS: AUTO-CALL IF CRITICAL</div>
                        </div>
                    </div>
                    <div class="bg-white/20 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                        <span>108 / 911</span>
                        <span class="animate-pulse">üìû</span>
                    </div>
                </div>
            </div>
            <div class="grid lg:grid-cols-2 gap-6 md:gap-8 mb-10">
                <div class="bg-white rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100">
                    <h3 class="font-bold text-lg md:text-xl text-slate-800 mb-6 flex items-center gap-2"><span class="bg-indigo-100 p-2 rounded-lg">üìÖ</span> Book Appointment</h3>
                    <form onsubmit="bookAppt(event)" class="space-y-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Full Name</label><input type="text" id="p-name" value="${currentUser.n}" readonly class="w-full px-4 py-3.5 rounded-2xl bg-slate-50 border-none text-slate-400 font-medium text-sm shadow-inner"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Age</label><input type="number" id="p-age" required class="w-full px-4 py-3.5 rounded-2xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all"></div>
                            <div><label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Phone</label><input type="text" id="p-phone" value="${currentUser.phone || ''}" placeholder="Mobile" class="w-full px-4 py-3.5 rounded-2xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2 ml-1">Primary Issue</label>
                            <select id="p-issue" onchange="analyzeSymptom(this.value)" class="w-full px-4 py-3.5 rounded-2xl border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all bg-white cursor-pointer">
                                <option value="">Select Symptoms...</option>
                                <option value="Fever">High Fever (>38¬∞C)</option>
                                <option value="Chest">Chest Pain</option>
                                <option value="Fracture">Bone Fracture</option>
                            </select>
                        </div>
                        <div id="ai-hint" class="hidden bg-indigo-50/80 border-l-4 border-indigo-500 rounded-r-2xl p-4 text-sm text-slate-700 mt-4 animate-fade-in">
                            <div class="font-bold text-indigo-600 mb-2 flex items-center gap-2">ü§ñ AI Analysis Result:</div>
                            <div id="typing-text" class="typing-cursor font-mono text-slate-600 leading-relaxed"></div>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 rounded-2xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all flex items-center justify-center gap-3">
                            <span>Send Request</span><span class="text-xl">üìÖ</span>
                        </button>
                    </form>
                </div>
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 md:p-8 shadow-xl text-white flex flex-col justify-between">
                     <div>
                        <h3 class="font-bold text-xl md:text-2xl mb-6 flex items-center gap-2"><span class="bg-indigo-600 p-2 rounded-lg">ü§ñ</span> AI Self-Check</h3>
                        <p class="text-slate-400 text-sm mb-6">Enter vitals for instant assessment.</p>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Temp (¬∞C)</label><input type="number" id="sc-temp" step="0.1" placeholder="36.5" class="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white outline-none placeholder-slate-500"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Heart Rate</label><input type="number" id="sc-hr" placeholder="72" class="w-full bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white outline-none placeholder-slate-500"></div>
                            </div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">BP (mmHg)</label><div class="flex gap-2"><input type="number" id="sc-bp-sys" placeholder="120 (Sys)" class="flex-1 bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white outline-none placeholder-slate-500"><input type="number" id="sc-bp-dia" placeholder="80 (Dia)" class="flex-1 bg-slate-700/50 border border-slate-600 rounded-xl px-4 py-3 text-white outline-none placeholder-slate-500"></div></div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button onclick="runPatientSelfCheck()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2"><span>Analyze My Health</span><span>ü§ñ</span></button>
                        <div id="self-check-result" class="hidden mt-4 animate-fade-in"><div class="h-px w-full bg-slate-600 my-4"></div><div id="sc-content" class="bg-white/5 rounded-xl p-4 border border-white/10"></div></div>
                    </div>
                </div>
            </div>
            <div class="animate-fade-in">
                <h3 class="text-xl md:text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2"><span class="text-3xl">üè•</span> Our Hospital Network</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${HOSPITALS.map(h => `<div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-md hover:shadow-xl transition-all hover:-translate-y-1 flex flex-col justify-between h-full group cursor-pointer"><div><div class="flex justify-between items-start mb-3"><div class="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center text-2xl group-hover:bg-indigo-100">${h.icon}</div><div class="bg-emerald-50 text-emerald-700 text-xs font-bold px-2 py-1 rounded-lg">‚≠ê ${h.rating}</div></div><h4 class="font-bold text-slate-800 text-lg mb-1 group-hover:text-indigo-600">${h.name}</h4><div class="flex items-center gap-2 text-sm text-slate-500 mb-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 116 0z"></path></svg>${h.loc}</div></div><div class="mt-4 pt-4 border-t border-slate-50 flex items-center justify-between"><span class="text-xs font-bold text-slate-400">${h.dist} away</span><span class="text-indigo-600 text-xs font-bold group-hover:underline">Visit Details ‚Üí</span></div></div>`).join('')}
                </div>
            </div>`;
        }

        function startEmergencyProtocol() {
            const overlay = document.getElementById('emergency-overlay');
            const content = document.getElementById('emergency-content');
            overlay.classList.remove('hidden');
            content.innerHTML = `<div class="animate-bounce"><div class="text-6xl md:text-8xl mb-6">üö®</div><h2 class="text-3xl md:text-5xl font-bold text-white mb-2">CRITICAL CONDITION</h2><div class="text-lg md:text-2xl text-red-100 font-mono mb-8">AUTO-DIALING AMBULANCE...</div><div class="text-2xl md:text-4xl font-bold text-white bg-red-500/50 inline-block px-6 py-2 rounded-lg">108 / 911</div></div>`;
            setTimeout(() => {
                content.innerHTML = `<div class="animate-slide-up"><div class="w-20 h-20 md:w-24 md:h-24 bg-green-500 rounded-full mx-auto mb-6 flex items-center justify-center shadow-2xl ring-4 ring-green-300"><svg class="w-10 h-10 md:w-12 md:h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div><h2 class="text-3xl md:text-4xl font-bold text-green-100 mb-2">CONNECTED</h2><p class="text-xl md:text-2xl text-white mb-8">Help is on the way.</p><button onclick="endEmergency()" class="mt-8 bg-white text-red-600 px-8 py-3 md:px-10 md:py-4 rounded-full font-bold text-lg shadow-xl hover:bg-gray-100 transition transform hover:scale-105">End Emergency Session</button></div>`;
            }, 3000);
        }
        function endEmergency() { document.getElementById('emergency-overlay').classList.add('hidden'); showToast('Emergency session ended.', 'success'); }

        function runPatientSelfCheck() {
            const temp = parseFloat(document.getElementById('sc-temp').value);
            const hr = parseInt(document.getElementById('sc-hr').value);
            const sys = parseInt(document.getElementById('sc-bp-sys').value);
            const dia = parseInt(document.getElementById('sc-bp-dia').value);
            if (!temp || !hr || !sys || !dia) { showToast("Please fill all vitals", 'error'); return; }
            const resBox = document.getElementById('self-check-result');
            const content = document.getElementById('sc-content');
            resBox.classList.remove('hidden');
            content.innerHTML = `<div class="flex items-center gap-3"><div class="animate-spin text-indigo-400">‚åõ</div><span>Analyzing Vitals...</span></div>`;
            setTimeout(() => {
                let risks = [];
                let statusColor = 'text-green-400';
                let statusIcon = 'üü¢';
                let recommendation = "Your vitals look normal. Keep up healthy lifestyle!";
                if (temp > 38.5) risks.push("High Fever"); else if (temp > 37.5) risks.push("Mild Fever");
                if (hr > 110) risks.push("Elevated Heart Rate"); else if (hr > 100) risks.push("Slightly High Heart Rate");
                if (sys > 140 || dia > 90) risks.push("Hypertension"); else if (sys > 120 || dia > 80) risks.push("Elevated BP"); else if (sys < 90) risks.push("Low BP");
                let isCritical = false;
                if (risks.length >= 2 || (temp > 39 || hr > 120 || sys > 160)) {
                    statusColor = 'text-red-400'; statusIcon = 'üî¥'; recommendation = "‚ö†Ô∏è Multiple abnormalities detected. Immediate attention required."; isCritical = true; 
                } else if (risks.length === 1) { statusColor = 'text-orange-400'; statusIcon = 'üü†'; recommendation = "One parameter is off. Monitor closely."; }
                content.innerHTML = `<div class="flex items-center justify-between mb-3"><div class="font-bold text-lg md:text-xl ${statusColor} flex items-center gap-2">${statusIcon} ${risks.length === 0 ? 'Healthy' : 'Attention Needed'}</div><div class="text-xs font-mono text-slate-400 bg-slate-800 px-2 py-1 rounded">AI VERIFIED</div></div><div class="space-y-2 mb-4 text-sm text-slate-300"><div class="flex justify-between border-b border-slate-700 pb-1"><span>Temperature:</span> <span class="${temp>37.5?'text-red-300':'text-slate-300'} font-mono">${temp}¬∞C</span></div><div class="flex justify-between border-b border-slate-700 pb-1"><span>Heart Rate:</span> <span class="${hr>100?'text-red-300':'text-slate-300'} font-mono">${hr} bpm</span></div><div class="flex justify-between border-b border-slate-700 pb-1"><span>BP:</span> <span class="${sys>120?'text-red-300':'text-slate-300'} font-mono">${sys}/${dia}</span></div></div><p class="text-sm text-white leading-relaxed">${recommendation}</p>`;
                if (isCritical) { setTimeout(() => { startEmergencyProtocol(); }, 1500); }
            }, 1000);
        }

        function analyzeSymptom(issue) {
            const box = document.getElementById('ai-hint');
            const txt = document.getElementById('typing-text');
            box.classList.remove('hidden');
            txt.innerHTML = '';
            const data = { 'Fever': "Analysis: High viral load suspected. Immediate CBC recommended.", 'Chest': "Analysis: Cardiac distress indicators detected. Immediate ECG required.", 'Fracture': "Analysis: Orthopedic injury. Immobilization critical. X-Ray ordered." };
            const message = data[issue] || "Waiting for input...";
            let i = 0;
            const interval = setInterval(() => { txt.innerHTML = message.substring(0, i+1); i++; if(i >= message.length) clearInterval(interval); }, 25);
        }
        function bookAppt(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const original = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block mr-2">‚åõ</span> Sending Request...`;
            btn.disabled = true;
            setTimeout(() => {
                const pName = currentUser.n;
                const pAge = document.getElementById('p-age').value;
                const pPhone = document.getElementById('p-phone').value;
                const pIssue = document.getElementById('p-issue').value;
                if(!pAge || !pPhone || !pIssue) { showToast('Missing Details', 'error'); btn.innerHTML = original; btn.disabled = false; return; }
                const newAppt = { id: Date.now(), u: currentUser.u, n: pName, age: pAge, phone: pPhone, issue: pIssue, status: 'pending', level: null, vitals: null, disease: null, bed: null, doc: null, meds: [] };
                DB.appointments.push(newAppt);
                saveDB();
                showToast('Request Sent Successfully', 'success');
                btn.innerHTML = original;
                btn.disabled = false;
                document.getElementById('p-age').value = '';
                document.getElementById('p-phone').value = '';
                document.getElementById('p-issue').value = '';
                document.getElementById('ai-hint').classList.add('hidden');
                navigate('patient-dashboard');
            }, 1000);
        }

        // --- ADMIN VIEW ---
        function renderAdmin(c) {
            const pending = DB.appointments.filter(a => a.status === 'pending');
            const history = DB.appointments.filter(a => a.status !== 'pending').sort((a,b) => b.id - a.id);
            c.innerHTML = `<div class="flex justify-between items-center mb-8"><h2 class="text-2xl md:text-4xl font-extrabold text-slate-800">Admin Dashboard</h2><span class="bg-indigo-100 text-indigo-700 px-4 py-1.5 rounded-full text-sm font-bold animate-pulse-fast">${pending.length} Pending</span></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">${pending.length === 0 ? `<div class="col-span-full bg-white p-12 rounded-3xl text-center shadow-xl border border-slate-100 animate-fade-in"><div class="text-5xl mb-4 opacity-40">üì≠</div><h3 class="text-xl font-bold text-slate-800">No Pending Requests</h3></div>` : pending.map(a => `<div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 flex flex-col justify-between h-full"><div class="mb-6"><div class="flex justify-between items-start"><div class="font-bold text-lg text-slate-800">${a.n}</div><span class="bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded-full text-xs font-bold border border-yellow-200">PENDING</span></div><div class="text-sm text-slate-500 space-y-2 bg-slate-50 p-3 rounded-2xl border border-slate-100 mt-4"><div>üìû ${a.phone}</div><div>üéÇ ${a.age} Years Old</div><div class="mt-3 pt-3 border-t border-slate-100 border-dashed">Issue: <span class="font-bold text-slate-700">${a.issue}</span></div></div></div><button onclick="approveReq(${a.id}, this)" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 rounded-2xl shadow-lg hover:shadow-2xl transform active:scale-95 transition-all">Approve & Assign</button></div>`).join('')}</div><div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden"><div class="p-6 bg-slate-50 border-b border-slate-200"><h3 class="text-2xl font-extrabold text-slate-800">AI Patient Database</h3></div><div class="overflow-x-auto"><table class="w-full text-left border-collapse min-w-[600px]"><thead><tr class="bg-slate-50 text-xs uppercase tracking-wider text-slate-500 font-semibold border-b border-slate-100"><th class="p-4">Patient</th><th class="p-4">Diagnosis</th><th class="p-4">Status</th></tr></thead><tbody class="text-sm">${history.length === 0 ? '<tr><td colspan="6" class="p-8 text-center text-slate-400">Database is empty.</td></tr>' : history.map(a => `<tr class="border-b border-slate-50 hover:bg-slate-50/50"><td class="p-4"><div class="font-bold text-slate-800">${a.n}</div></td><td class="p-4"><div class="font-medium text-slate-700">${a.disease || '-'}</div></td><td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold uppercase border ${getStatusBadge(a.status)}">${a.status}</span></td></tr>`).join('')}</tbody></table></div></div>`;
        }
        function getStatusBadge(status) {
            if (status === 'accepted') return 'bg-blue-100 text-blue-700 border-blue-200';
            if (status === 'diagnosed') return 'bg-indigo-100 text-indigo-700 border-indigo-200';
            if (status === 'admitted') return 'bg-emerald-100 text-emerald-700 border-emerald-200';
            return 'bg-slate-100 text-slate-400';
        }
        function approveReq(id, btn) {
            const apt = DB.appointments.find(a => a.id === id);
            if(!apt) return;
            const doc = DB.doctors[Math.floor(Math.random() * DB.doctors.length)];
            btn.innerHTML = `<span class="animate-spin inline-block">‚åõ</span> Assigning...`;
            setTimeout(() => { apt.doc = doc.n; apt.status = 'accepted'; saveDB(); showToast(`Assigned to ${doc.n}`, 'success'); renderAdmin(document.getElementById('main-content')); }, 800);
        }

        // --- DOCTOR VIEW ---
        function renderDoctor(c) {
            const patients = DB.appointments.filter(a => a.status === 'accepted');
            c.innerHTML = `<h2 class="text-2xl md:text-4xl font-extrabold text-slate-800 mb-8 md:mb-10">AI Diagnosis Center</h2>${patients.length === 0 ? `<div class="bg-white p-12 rounded-3xl text-center shadow-xl border border-slate-100 animate-fade-in"><div class="text-5xl mb-4 opacity-40">ü©∫</div><h3 class="text-xl font-bold text-slate-800">Waiting Room Empty</h3></div>` : `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">${patients.map(a => `<div class="bg-white rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100"><div class="flex justify-between items-center mb-6"><div class="font-bold text-xl text-slate-800">${a.n}</div><div class="text-xs text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full border border-indigo-100 font-bold">${a.doc}</div></div><div class="bg-slate-50 rounded-2xl p-5 mb-6 border border-slate-100"><div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Enter Patient Vitals</div><div class="flex gap-4"><div class="flex-1"><label class="text-sm font-medium text-slate-600 mb-1 ml-1">Heart Rate</label><input type="number" id="hr-${a.id}" placeholder="bpm" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all bg-white shadow-sm"></div><div class="flex-1"><label class="text-sm font-medium text-slate-600 mb-1 ml-1">Temp</label><input type="number" id="temp-${a.id}" placeholder="¬∞C" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all bg-white shadow-sm"></div></div></div><div id="result-${a.id}" class="hidden mb-6 animate-fade-in"><div class="bg-emerald-50/90 border border-emerald-200 rounded-2xl p-5 mb-4"><div class="font-bold text-emerald-700 mb-2">ü§ñ AI Analysis Result</div><div id="disease-${a.id}" class="font-bold text-slate-800 text-lg">Analyzing...</div></div></div><div id="meds-container-${a.id}" class="hidden mb-6 animate-fade-in"><div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-5"><div class="flex items-center gap-2 mb-3 text-indigo-800 font-bold"><span>üíä</span> <span class="uppercase text-xs tracking-wide opacity-70">Suggested Medication</span></div><div id="meds-list-${a.id}" class="flex flex-wrap gap-2 mb-4"></div><button id="btn-prescribe-${a.id}" onclick="prescribeMeds(${a.id})" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md hover:shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2"><span>Prescribe & Send to Nurse</span><span>‚ûî</span></button></div></div><button id="diag-btn-${a.id}" onclick="runDiagnosis(${a.id}, this)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-2xl shadow-lg hover:shadow-2xl transform active:scale-95 transition-all flex items-center justify-center gap-2"><span>Run AI Diagnosis</span><span class="text-xl">üî¨</span></button></div>`).join('')}</div>`}`;
        }
        function runDiagnosis(id, btn) {
            const apt = DB.appointments.find(a => a.id === id);
            const hr = document.getElementById(`hr-${id}`).value;
            const temp = document.getElementById(`temp-${id}`).value;
            if(!hr || !temp) return showToast('Enter Vitals', 'error');
            const resBox = document.getElementById(`result-${id}`);
            btn.innerHTML = `<span class="animate-spin inline-block">‚åõ</span> AI Processing...`;
            btn.disabled = true;
            setTimeout(() => {
                let disease = "Viral Fever";
                let level = "Stable (ESI 3)";
                let suggestedMeds = ["Paracetamol 500mg", "ORS (Hydration)", "Bed Rest"];
                if(temp > 39 && hr > 100) { disease = "Sepsis / Critical"; level = "Critical (ESI 1)"; suggestedMeds = ["IV Antibiotics", "Vasopressors", "ICU Admission"]; } 
                else if(hr > 110) { disease = "Tachycardia"; level = "Urgent (ESI 2)"; suggestedMeds = ["Beta Blockers", "ECG Monitoring", "Sedation"]; } 
                else if(temp > 38) { disease = "High Grade Fever"; level = "Urgent (ESI 2)"; suggestedMeds = ["Ibuprofen", "Cold Compress", "Fluid Intake"]; }
                apt.disease = disease; apt.level = level; apt.vitals = { hr, temp }; apt.meds = suggestedMeds; apt.status = 'diagnosed';
                resBox.classList.remove('hidden');
                document.getElementById(`disease-${id}`).innerText = disease;
                const medsContainer = document.getElementById(`meds-container-${id}`);
                const medsList = document.getElementById(`meds-list-${id}`);
                medsContainer.classList.remove('hidden');
                medsList.innerHTML = suggestedMeds.map(m => `<span class="bg-white px-3 py-1.5 rounded-full text-xs font-bold text-indigo-700 border border-indigo-200 shadow-sm flex items-center gap-1"><span>üíä</span> ${m}</span>`).join('');
                showToast(`Diagnosed: ${disease}`, 'success');
                btn.classList.add('hidden');
            }, 1500);
        }
        function prescribeMeds(id) {
            const btn = document.getElementById(`btn-prescribe-${id}`);
            btn.disabled = true;
            btn.innerHTML = `<span>Sent to Nurse ‚úÖ</span>`;
            btn.classList.replace('bg-indigo-600', 'bg-emerald-500');
            saveDB();
            showToast('Prescription sent to Nurse Portal', 'success');
        }

        // --- NURSE VIEW ---
        function renderNurse(c) {
            const patients = DB.appointments.filter(a => a.status === 'diagnosed');
            const bestBed = DB.beds.find(b => b.status === 'free');
            const mainFree = DB.beds.filter(b => b.status === 'free').length;
            const emgFree = DB.roughBeds.filter(b => b.status === 'free').length;
            c.innerHTML = `<h2 class="text-2xl md:text-4xl font-extrabold text-slate-800 mb-6 md:mb-8">Smart Bed Management</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"><div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 flex items-center justify-between"><div><div class="text-sm text-slate-500 font-bold uppercase tracking-wider mb-1">Main Ward</div><div class="text-3xl font-extrabold text-indigo-600">${mainFree} <span class="text-slate-300 text-lg font-normal">Free</span></div></div><div class="w-16 h-16 rounded-full bg-indigo-50 flex items-center justify-center text-2xl">üè•</div></div><div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 flex items-center justify-between"><div><div class="text-sm text-slate-500 font-bold uppercase tracking-wider mb-1">Emergency</div><div class="text-3xl font-extrabold text-red-600">${emgFree} <span class="text-slate-300 text-lg font-normal">Free</span></div></div><div class="w-16 h-16 rounded-full bg-red-50 flex items-center justify-center text-2xl">üöë</div></div></div><div class="grid lg:grid-cols-12 gap-6 md:gap-8 items-start"><div class="lg:col-span-4 space-y-6">${patients.length === 0 ? `<div class="bg-white p-8 rounded-3xl text-center shadow-xl border border-slate-100 animate-fade-in"><div class="text-4xl mb-2 opacity-40">‚úÖ</div><h3 class="font-bold text-slate-800">No Patients Waiting</h3></div>` : patients.map(a => `<div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 animate-fade-in"><div class="flex justify-between items-center mb-4"><div class="font-bold text-lg text-slate-800">${a.n}</div><div class="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded-full border border-indigo-100 font-bold">DIAGNOSED</div></div><div class="text-sm text-slate-500 mb-4">Diagnosis: <span class="font-bold text-red-600">${a.disease}</span></div><div id="bed-res-${a.id}" class="hidden bg-blue-50 border border-blue-100 rounded-2xl p-3 mb-4 text-sm text-blue-800 flex items-center gap-2"><span class="animate-pulse">üîç</span><span id="bed-txt-${a.id}">Scanning Hospital DB...</span></div><button onclick="assignBed(${a.id}, this)" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-2xl shadow-md hover:shadow-lg transform active:scale-95 transition-all">Allocate AI Suggested Bed</button></div>`).join('')}</div><div class="lg:col-span-8 space-y-8"><div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100"><h3 class="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2"><span class="bg-emerald-100 text-emerald-600 p-1.5 rounded-lg text-sm">E1-E20</span> Main Ward</h3><div class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-3">${DB.beds.map(b => generateBedHTML(b, bestBed, false)).join('')}</div></div></div></div>`;
        }
        function generateBedHTML(b, suggestedBed, isRough) {
            const isFree = b.status === 'free';
            const isSuggested = suggestedBed && b.id === suggestedBed.id;
            let baseClasses = "relative w-full aspect-square rounded-xl border-2 flex flex-col items-center justify-center transition-all duration-300 hover:-translate-y-1 select-none ";
            baseClasses += isFree ? "bg-emerald-50 border-emerald-200 text-emerald-600 shadow-sm hover:shadow-md hover:border-emerald-400" : "bg-slate-50 border-slate-100 text-slate-300 opacity-60 cursor-not-allowed";
            if (isSuggested) baseClasses += " ai-bed-highlight bg-indigo-100 border-indigo-500";
            return `<div class="${baseClasses}"><div class="text-xl md:text-2xl mb-1">üõèÔ∏è</div><div class="text-[10px] md:text-xs font-bold font-mono tracking-wide">${b.label}</div><div class="absolute top-2 right-2 w-2 h-2 rounded-full ${isFree ? 'bg-emerald-500' : 'bg-slate-300'}"></div>${isSuggested ? `<div class="absolute -top-2 -right-2 bg-indigo-600 text-white text-[10px] px-1.5 py-0.5 rounded-full shadow-md animate-bounce border border-white font-bold">AI</div>` : ''}</div>`;
        }
        function assignBed(id, btn) {
            const apt = DB.appointments.find(a => a.id === id);
            let freeBed = DB.beds.find(b => b.status === 'free');
            const resBox = document.getElementById(`bed-res-${id}`);
            resBox.classList.remove('hidden');
            btn.innerHTML = `<span class="animate-spin inline-block">‚åõ</span> Allocating...`;
            btn.disabled = true;
            setTimeout(() => {
                if(freeBed) {
                    resBox.innerHTML = `<span class="text-emerald-600 font-bold text-lg">‚úì</span> <span>Allocated: <strong>Standard Ward Bed ${freeBed.id}</strong></span>`;
                    apt.bed = freeBed.id; apt.status = 'admitted';
                    const bedIndex = DB.beds.findIndex(b => b.id === freeBed.id);
                    DB.beds[bedIndex].status = 'occupied';
                    DB.beds[bedIndex].patientId = apt.n;
                    saveDB();
                    showToast(`Allocated Standard Bed ${freeBed.id}`, 'success');
                    setTimeout(() => renderNurse(document.getElementById('main-content')), 1500);
                } else {
                    resBox.innerText = "‚ùå Hospital Full";
                    showToast('Capacity Reached', 'error');
                    btn.disabled = false;
                    btn.innerHTML = 'Retry';
                }
            }, 1000);
        }

        // --- CHATBOT & VOICE ---
        function toggleChat() {
            const win = document.getElementById('chat-window');
            const btn = document.getElementById('chat-toggle-btn');
            if (win.classList.contains('hidden')) {
                win.classList.remove('hidden');
                requestAnimationFrame(() => { win.classList.remove('scale-95', 'opacity-0'); win.classList.add('scale-100', 'opacity-100'); });
                btn.innerHTML = '‚úï'; btn.classList.remove('bg-indigo-600', 'animate-pulse-fast', 'border-indigo-200', 'ring-indigo-200'); btn.classList.add('bg-slate-800', 'border-slate-300', 'scale-90');
            } else {
                win.classList.remove('scale-100', 'opacity-100');
                win.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { win.classList.add('hidden'); }, 300);
                btn.innerHTML = 'üí¨'; btn.classList.add('bg-indigo-600', 'animate-pulse-fast', 'border-indigo-200', 'ring-indigo-200'); btn.classList.remove('bg-slate-800', 'border-slate-300', 'scale-90');
            }
        }

        function startVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { showToast("Voice input not supported.", 'error'); return; }

            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            const btn = document.getElementById('voice-btn');
            const originalBtnIcon = btn.innerHTML;
            
            btn.classList.add('bg-red-100', 'text-red-600', 'animate-pulse');
            btn.classList.remove('bg-slate-100', 'text-slate-500');
            btn.innerHTML = `<svg class="w-5 h-5 animate-pulse" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path></svg>`;
            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chat-input').value = transcript;
                resetVoiceBtn(btn, originalBtnIcon);
                sendChat();
            };

            recognition.onerror = (event) => {
                console.error("Speech Error:", event.error);
                let msg = "Voice error.";
                if (event.error === 'not-allowed') msg = "Microphone permission denied.";
                else if (event.error === 'no-speech') msg = "No speech detected.";
                else if (event.error === 'network') msg = "Network error.";
                showToast(msg, 'warning');
                resetVoiceBtn(btn, originalBtnIcon);
            };

            recognition.onend = () => resetVoiceBtn(btn, originalBtnIcon);
        }

        function resetVoiceBtn(btn, icon) {
            btn.classList.remove('bg-red-100', 'text-red-600', 'animate-pulse');
            btn.classList.add('bg-slate-100', 'text-slate-500');
            btn.innerHTML = icon;
        }

        function sendChat() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt) return;
            const body = document.getElementById('chat-messages');
            body.innerHTML += `<div class="ml-auto bg-indigo-600 text-white rounded-2xl rounded-br-none p-4 text-sm shadow-md max-w-[85%] animate-slide-up">${txt}</div>`;
            inp.value = '';
            body.scrollTop = body.scrollHeight;
            setTimeout(() => {
                const replyHTML = generateMedicalResponse(txt);
                body.innerHTML += `<div class="mr-auto bg-white text-slate-800 rounded-2xl rounded-bl-none p-4 text-sm shadow-sm border border-slate-100 max-w-[90%] animate-slide-up">${replyHTML}</div>`;
                body.scrollTop = body.scrollHeight;
            }, 600);
        }
        
        // --- SMART AI RESPONSE LOGIC ---
        function generateMedicalResponse(input) {
            const lowerInput = input.toLowerCase();
            let bestMatch = null; 
            let maxMatches = 0;
            
            // Search Knowledge Base
            MEDICAL_KNOWLEDGE_BASE.forEach(entry => {
                let matches = 0;
                entry.keywords.forEach(kw => { if (lowerInput.includes(kw)) matches++; });
                if (matches > 0 && matches >= maxMatches) { maxMatches = matches; bestMatch = entry; }
            });
            
            if (bestMatch) {
                let urgencyColor = bestMatch.urgency === 'critical' ? 'border-red-500 bg-red-50' : (bestMatch.urgency === 'high' ? 'border-orange-400 bg-orange-50' : 'border-blue-400 bg-blue-50');
                
                // Construct Detailed Solution
                return `
                    <div class="border-l-4 ${urgencyColor} p-3 rounded-lg mb-2">
                        <div class="font-bold text-slate-800 mb-1 flex items-center gap-2">
                            ü©∫ ${bestMatch.condition}
                        </div>
                        <div class="text-slate-700 mb-2">${bestMatch.solution}</div>
                        <div class="text-xs text-slate-600 bg-white/50 p-2 rounded border border-slate-100 mb-2">
                            <strong>üíä Suggested Meds:</strong> ${bestMatch.meds}
                        </div>
                        <div class="text-xs text-red-700 font-bold mt-1">‚ö†Ô∏è ${bestMatch.warning}</div>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-2 italic">AI Suggestion. Consult a doctor for accurate diagnosis.</div>
                `;
            }
            
            // Fallback
            return `<div class="p-3 bg-slate-50 rounded-lg">I couldn't find a specific solution for that. If it's an emergency, please use the <strong>Emergency Button</strong>. Otherwise, try describing your symptoms (e.g., "I have a headache").</div>`;
        }

        function showToast(msg, type) {
            const area = document.getElementById('toast-area');
            const t = document.createElement('div');
            if (type === 'info') { t.className = "bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-slide-up border border-blue-500"; } 
            else if(type === 'success') { t.className = "bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-slide-up border border-emerald-500"; } 
            else if (type === 'warning') { t.className = "bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-slide-up border-orange-500"; } 
            else { t.className = "bg-red-500 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-slide-up border-red-200"; } 
            let icon = type==='success'?'‚úÖ':(type==='warning'?'‚ö†Ô∏è':(type==='info'?'üîë':'üö®'));
            t.innerHTML = `<span class="text-xl">${icon}</span> <span class="font-semibold text-sm md:text-lg">${msg}</span>`;
            area.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(20px)'; setTimeout(() => t.remove(), 300); }, 3000);
        }
    </script>
</body>
</html>
